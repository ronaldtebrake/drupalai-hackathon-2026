<?php

/**
 * @file
 * Module hooks for misstraal_ai_contexts.
 */

declare(strict_types=1);

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Form\NodeForm;
use Drupal\node\NodeInterface;
use Drupal\Core\Entity\ContentEntityStorageInterface;


/**
 * Implements hook_form_alter().
 */
function misstraal_ai_contexts_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  $form_object = $form_state->getFormObject();
  if (!($form_object instanceof NodeForm)) {
    return;
  }

  $node = $form_object->getEntity();
  if (!($node instanceof NodeInterface) || $node->bundle() !== 'article') {
    return;
  }

  // Hide fields from the form UI.
  $fields_to_hide = [
    'field_ai_reasoning',
    'field_ai_score',
    'field_editorial_source',
    'field_editorial_score',
    'field_editorial_subject',
    'field_editorial_description',
  ];

  foreach ($fields_to_hide as $field_name) {
    if (isset($form[$field_name])) {
      $form[$field_name]['#access'] = FALSE;
    }
  }

  // Inject a stylable panel onto the form so editors can still
  // see the values without editing the raw fields.
  try {
    $form['#attached']['library'][] = 'misstraal_ai_contexts/admin_form_panel';

    $items = misstraal_ai_contexts_build_article_meta_items($node);
    $title_revision_items = misstraal_ai_contexts_build_node_title_revision_items($node);

    $form['misstraal_ai_meta_panel'] = [
      '#type' => 'container',
      '#weight' => -50,
      '#attributes' => [
        'class' => ['misstraal-ai-contexts-form-panel'],
      ],
      'panel' => [
        '#theme' => 'misstraal_article_ai_editorial_meta_panel',
        '#title' => t('AI & editorial metadata'),
        '#items' => $items,
      ],
    ];
    $form['misstraal_title_revision_panel'] = [
      '#type' => 'container',
      '#weight' => -49, // Right after the AI meta panel
      '#attributes' => [
        'class' => ['misstraal-ai-contexts-form-panel'],
      ],
      'panel' => [
        '#theme' => 'misstraal_article_ai_editorial_meta_panel',
        '#title' => t('Editorial feedback'),
        '#items' => $title_revision_items,
      ],
    ];
  }
  catch (\Throwable $e) {
    // Never block content editing because a helper panel failed.
    \Drupal::logger('misstraal_ai_contexts')->warning('Failed to add the Article AI/Editorial panel to the form: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_theme().
 */
function misstraal_ai_contexts_theme($existing, $type, $theme, $path): array {
  return [
    'misstraal_article_ai_editorial_meta_panel' => [
      'variables' => [
        'title' => NULL,
        'items' => [],
      ],
      'template' => 'misstraal-article-ai-editorial-meta-panel',
    ],
  ];
}

/**
 * Build items for the Article AI/editorial meta panel.
 */
function misstraal_ai_contexts_build_article_meta_items(NodeInterface $node): array {
  $items = [];

  $map = [
    'field_ai_score' => t('AI score'),
    'field_ai_reasoning' => t('AI reasoning'),
    'field_editorial_score' => t('Editorial score'),
    'field_editorial_source' => t('Editorial source'),
    'field_editorial_subject' => t('Editorial subject'),
    'field_editorial_description' => t('Editorial description'),
  ];

  foreach ($map as $field_name => $label) {
    if (!$node->hasField($field_name) || $node->get($field_name)->isEmpty()) {
      continue;
    }

    $field = $node->get($field_name);
    $first = $field->first();
    $value = NULL;

    if (isset($first->processed)) {
      $value = $first->processed;
    }
    elseif (isset($first->value)) {
      $value = $first->value;
    }

    if (is_array($value)) {
      $value = implode("\n", $value);
    }

    $items[] = [
      'label' => (string) $label,
      'value' => $value,
    ];
  }

  return $items;
}

/**
 * Build items for the Node title & revision log panel.
 */
function misstraal_ai_contexts_build_node_title_revision_items(NodeInterface $node): array {
  $items = [];

  // Add node title
  $title = $node->getTitle();
  if (!empty($title)) {
    $items[] = [
      'label' => (string) t('Title'),
      'value' => $title,
    ];
  }

  // Add revision log messages from all revisions
  $storage = \Drupal::entityTypeManager()->getStorage('node');
  if ($storage instanceof ContentEntityStorageInterface) {
    $revision_ids = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('nid', $node->id())
      ->allRevisions()
      ->sort('vid', 'DESC')
      ->execute();

    $revision_logs = [];
    foreach ($revision_ids as $revision_id => $entity_id) {
      $revision = $storage->loadRevision($revision_id);
      if ($revision instanceof NodeInterface) {
        $revision_log = $revision->getRevisionLogMessage();
        if (!empty($revision_log)) {
          $revision_created = $revision->getRevisionCreationTime();
          $revision_user = $revision->getRevisionUser();
          $username = $revision_user ? $revision_user->getAccountName() : (string) t('Anonymous');
          $date = \Drupal::service('date.formatter')->format($revision_created, 'short');
          $revision_logs[] = [
            'date' => $date,
            'user' => $username,
            'message' => $revision_log,
          ];
        }
      }
    }

    if (!empty($revision_logs)) {
      $formatted_logs = [];
      foreach ($revision_logs as $log) {
        $formatted_logs[] = t('@date by @user: @message', [
          '@date' => $log['date'],
          '@user' => $log['user'],
          '@message' => $log['message'],
        ]);
      }
      $items[] = [
        'label' => (string) t('Editor feedback'),
        'value' => implode('<br><br>', $formatted_logs),
      ];
    }
    else {
        $items[] = [
            'label' => (string) t('Editor feedback'),
            'value' => 'Log messages not found',
          ];
    }
  }

  return $items;
}
