<?php

/**
 * @file
 * Module hooks for misstraal_ai_contexts.
 */

declare(strict_types=1);

use Drupal\Core\Form\FormStateInterface;
use Drupal\node\Form\NodeForm;
use Drupal\node\NodeInterface;
use Drupal\Core\Entity\ContentEntityStorageInterface;
use League\CommonMark\CommonMarkConverter;


/**
 * Implements hook_form_alter().
 */
function misstraal_ai_contexts_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  $form_object = $form_state->getFormObject();
  if (!($form_object instanceof NodeForm)) {
    return;
  }

  $node = $form_object->getEntity();
  if (!($node instanceof NodeInterface) || $node->bundle() !== 'article') {
    return;
  }

  // Hide fields from the form UI.
  $fields_to_hide = [
    'field_ai_reasoning',
    'field_ai_score',
    'field_editorial_source',
    'field_editorial_score',
    'field_editorial_subject',
    'field_editorial_description',
  ];

  foreach ($fields_to_hide as $field_name) {
    if (isset($form[$field_name])) {
      $form[$field_name]['#access'] = FALSE;
    }
  }

  // Inject a stylable panel onto the form so editors can still
  // see the values without editing the raw fields.
  try {
    $form['#attached']['library'][] = 'misstraal_ai_contexts/admin_form_panel';

    $items = misstraal_ai_contexts_build_article_meta_items($node);
    $title_revision_items = misstraal_ai_contexts_build_node_title_revision_items($node);

    $form['misstraal_ai_meta_panel'] = [
      '#type' => 'container',
      '#weight' => -50,
      '#attributes' => [
        'class' => ['misstraal-ai-contexts-form-panel'],
      ],
      'panel' => [
        '#theme' => 'misstraal_article_ai_editorial_meta_panel',
        '#title' => t('AI & editorial metadata'),
        '#items' => $items,
      ],
    ];
    $form['misstraal_title_revision_panel'] = [
      '#type' => 'container',
      '#weight' => -49, // Right after the AI meta panel
      '#attributes' => [
        'class' => ['misstraal-ai-contexts-form-panel'],
      ],
      'panel' => [
        '#theme' => 'misstraal_article_ai_editorial_meta_panel',
        '#title' => t('Editorial feedback'),
        '#items' => $title_revision_items,
      ],
    ];
  }
  catch (\Throwable $e) {
    // Never block content editing because a helper panel failed.
    \Drupal::logger('misstraal_ai_contexts')->warning('Failed to add the Article AI/Editorial panel to the form: @message', [
      '@message' => $e->getMessage(),
    ]);
  }
}

/**
 * Implements hook_theme().
 */
function misstraal_ai_contexts_theme($existing, $type, $theme, $path): array {
  return [
    'misstraal_article_ai_editorial_meta_panel' => [
      'variables' => [
        'title' => NULL,
        'items' => [],
      ],
      'template' => 'misstraal-article-ai-editorial-meta-panel',
    ],
  ];
}

/**
 * Build items for the Article AI/editorial meta panel.
 */
function misstraal_ai_contexts_build_article_meta_items(NodeInterface $node): array {
  $items = [];

  $map = [
    // 'field_ai_score' => t('AI score'),
    // 'field_ai_reasoning' => t('AI reasoning'),
    'field_editorial_score' => t('Editorial score'),
    'field_editorial_source' => t('Editorial source'),
    'field_editorial_subject' => t('Editorial subject'),
    'field_editorial_description' => t('Editorial description'),
  ];

  foreach ($map as $field_name => $label) {
    if (!$node->hasField($field_name) || $node->get($field_name)->isEmpty()) {
      continue;
    }

    $field = $node->get($field_name);
    $first = $field->first();
    $value = NULL;

    // For markdown fields, always use raw value so we can convert markdown ourselves.
    $reasoning_fields = ['field_ai_reasoning', 'field_editorial_description'];
    $is_markdown_field = in_array($field_name, $reasoning_fields, TRUE);

    if ($is_markdown_field) {
      // Always use raw value for markdown fields.
      if (isset($first->value)) {
        $value = $first->value;
      }
    }
    else {
      // For other fields, prefer processed value if available.
      if (isset($first->processed)) {
        $value = $first->processed;
      }
      elseif (isset($first->value)) {
        $value = $first->value;
      }
    }

    if (is_array($value)) {
      $value = implode("\n", $value);
    }

    // Convert markdown to HTML for reasoning fields.
    if ($is_markdown_field && is_string($value) && !empty($value)) {
      $value = misstraal_ai_contexts_convert_markdown_to_html($value);
    }

    $items[] = [
      'label' => (string) $label,
      'value' => $value,
    ];
  }

  return $items;
}

/**
 * Converts Markdown to HTML using CommonMark.
 *
 * @param string $markdown
 *   The markdown text to convert.
 *
 * @return string
 *   The HTML output.
 */
function misstraal_ai_contexts_convert_markdown_to_html(string $markdown): string {
  try {
    // Allow HTML for color spans and other formatting, but escape unsafe HTML.
    $converter = new CommonMarkConverter([
      'html_input' => 'allow', // Allow HTML tags like <span> for color indicators
      'allow_unsafe_links' => FALSE,
    ]);
    return $converter->convert($markdown)->getContent();
  }
  catch (\Exception $e) {
    // If markdown conversion fails, return the original text.
    \Drupal::logger('misstraal_ai_contexts')->warning('Failed to convert markdown to HTML: @error', [
      '@error' => $e->getMessage(),
    ]);
    return $markdown;
  }
}

/**
 * Build items for the Node title & revision log panel.
 */
function misstraal_ai_contexts_build_node_title_revision_items(NodeInterface $node): array {
  $items = [];

//   // Add node title
//   $title = $node->getTitle();
//   if (!empty($title)) {
//     $items[] = [
//       'label' => (string) t('Title'),
//       'value' => $title,
//     ];
//   }

  // Load all article nodes and collect their revision log messages
  $storage = \Drupal::entityTypeManager()->getStorage('node');
  if ($storage instanceof ContentEntityStorageInterface) {
    // Query all article nodes
    $article_ids = $storage->getQuery()
      ->accessCheck(FALSE)
      ->condition('type', 'article')
      ->sort('changed', 'DESC')
      ->execute();

    $all_feedback = [];

    foreach ($article_ids as $article_id) {
      $article = $storage->load($article_id);
      if (!($article instanceof NodeInterface)) {
        continue;
      }

      // Get all revisions for this article
      $revision_ids = $storage->getQuery()
        ->accessCheck(FALSE)
        ->condition('nid', $article_id)
        ->allRevisions()
        ->sort('vid', 'DESC')
        ->execute();

      $article_logs = [];
      foreach ($revision_ids as $revision_id => $entity_id) {
        $revision = $storage->loadRevision($revision_id);
        if ($revision instanceof NodeInterface) {
          $revision_log = $revision->getRevisionLogMessage();
          if (!empty($revision_log)) {
            $revision_created = $revision->getRevisionCreationTime();
            $revision_user = $revision->getRevisionUser();
            $username = $revision_user ? $revision_user->getAccountName() : (string) t('Anonymous');
            $date = \Drupal::service('date.formatter')->format($revision_created, 'short');
            $article_logs[] = [
              'date' => $date,
              'user' => $username,
              'message' => $revision_log,
            ];
          }
        }
      }

      if (!empty($article_logs)) {
        $all_feedback[] = [
          'title' => $article->getTitle(),
          'nid' => $article_id,
          'logs' => $article_logs,
        ];
      }
    }

    // Format all feedback by article - create separate item for each article
    if (!empty($all_feedback)) {
      foreach ($all_feedback as $article_feedback) {
        $formatted_logs = [];
        foreach ($article_feedback['logs'] as $log) {
          $formatted_logs[] = t('@date by @user: @message', [
            '@date' => $log['date'],
            '@user' => $log['user'],
            '@message' => $log['message'],
          ]);
        }

        $items[] = [
          'label' => htmlspecialchars($article_feedback['title']),
          'value' => implode('<br><br>', $formatted_logs),
        ];
      }
    }
    else {
      $items[] = [
        'label' => (string) t('Editor feedback'),
        'value' => 'Log messages not found',
      ];
    }
  }

  return $items;
}
